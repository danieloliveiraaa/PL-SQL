--CREATE BY DANIEL OLIVEIRA
--09/08/2021
--CORRIGIR O ERRO 50 CARACTERES--

CREATE OR REPLACE PROCEDURE "sp_erro_caracteres"(p_CODIGO_USUARIO IN TDVADM.T_USU_USUARIO.USU_USUARIO_CODIGO%TYPE,
                                                 p_MENSAGEM OUT VARCHAR2)
AS  
   --AUXILIAR
   V_CODIGO_EXISTE NUMBER;
   V_LENGTH NUMBER;
   V_NOME VARCHAR2;
   
BEGIN
   --ANALISA O QUE FOI DIGITADO COMO PARÂMETRO DE ENTRADA (IN)
   IF p_CODIGO_USUARIO IS NULL THEN
     
     p_MENSAGEM := 'DIGITE UM USUÁRIO VÁLIDO';
   
   ELSE
     --VERIFICA SE O USUÁRIO EXISTE,
     SELECT COUNT(*)
     INTO V_CODIGO_EXISTE
     FROM TDVADM.T_USU_USUARIO U
     WHERE U.USU_USUARIO_CODIGO = p_CODIGO_USUARIO;
     
     --CASO EXISTA...
     IF V_CODIGO_EXISTE > 0 THEN
       
       --VERIFICA QUANTOS CARACTERES O NOME DESTE USUÁRIO CONTÉM
       
       SELECT LENGTH (U1.USU_USUARIO_NOME)
       INTO V_LENGTH
       FROM TDVADM.T_USU_USUARIO U1
       WHERE U1.USU_USUARIO_CODIGO = p_CODIGO_USUARIO;
       
       --ANALISA SE O TAMANHO É MAIOR QUE 50 CARACTERES
       --E REALIZA A INSTRUÇÃO ABAIXO

       IF (V_LENGTH > 50) THEN
          
          --CORTA O NOME UTILIZANDO SUBSTRING, ENTRE O 1º ATÉ 50º CARACTERE 
          --E ARMAZENA NA VARIÁVEL V_NOME
	
          SELECT SUBSTR2(U2.USU_USUARIO_NOME,1,50)
          INTO V_NOME
          FROM TDVADM.T_USU_USUARIO U2
          WHERE U2.USU_USUARIO_CODIGO = p_CODIGO_USUARIO;
          
          --ATUALIZA O NOME DO USUÁRIO, BASEADO NO QUE FOI ARMAZENADO NO V_NOME
          UPDATE TDVADM.T_USU_USUARIO U3
          SET U3.USU_USUARIO_NOME = V_NOME
          WHERE U3.USU_USUARIO_CODIGO = p_CODIGO_USUARIO;
          p_MENSAGEM := 'USUÁRIO ATUALIZADO!'; 
       
       ELSE
         
          p_MENSAGEM := 'O NOME DESTE USUÁRIO JÁ ESTA COM 50 OU MENOS CARACTERES.';  
          
       END IF;
       
     ELSE
       
       p_MENSAGEM := 'USUÁRIO NÃO EXISTE';
       
     END IF;
   
   END IF;
     
END sp_erro_caracteres;
